% Template for PLoS
% Version 3.6 Aug 2022
% SEE https://ulriklyngs.com/post/2021/12/02/how-to-adapt-any-latex-template-for-use-with-r-markdown-in-four-steps/
%
% % % % % % % % % % % % % % % % % % % % % %
%
% -- IMPORTANT NOTE
%
% This template contains comments intended 
% to minimize problems and delays during our production 
% process. Please follow the template instructions
% whenever possible.
%
% % % % % % % % % % % % % % % % % % % % % % % 
%
% Once your paper is accepted for publication, 
% PLEASE REMOVE ALL TRACKED CHANGES in this file 
% and leave only the final text of your manuscript. 
% PLOS recommends the use of latexdiff to track changes during review, as this will help to maintain a clean tex file.
% Visit https://www.ctan.org/pkg/latexdiff?lang=en for info or contact us at latex@plos.org.
%
%
% There are no restrictions on package use within the LaTeX files except that no packages listed in the template may be deleted.
%
% Please do not include colors or graphics in the text.
%
% The manuscript LaTeX source should be contained within a single file (do not use \input, \externaldocument, or similar commands).
%
% % % % % % % % % % % % % % % % % % % % % % %
%
% -- FIGURES AND TABLES
%
% Please include tables/figure captions directly after the paragraph where they are first cited in the text.
%
% DO NOT INCLUDE GRAPHICS IN YOUR MANUSCRIPT
% - Figures should be uploaded separately from your manuscript file. 
% - Figures generated using LaTeX should be extracted and removed from the PDF before submission. 
% - Figures containing multiple panels/subfigures must be combined into one image file before submission.
% For figure citations, please use "Fig" instead of "Figure".
% See http://journals.plos.org/plosone/s/figures for PLOS figure guidelines.
%
% Tables should be cell-based and may not contain:
% - spacing/line breaks within cells to alter layout or alignment
% - do not nest tabular environments (no tabular environments within tabular environments)
% - no graphics or colored text (cell background color/shading OK)
% See http://journals.plos.org/plosone/s/tables for table guidelines.
%
% For tables that exceed the width of the text column, use the adjustwidth environment as illustrated in the example table in text below.
%
% % % % % % % % % % % % % % % % % % % % % % % %
%
% -- EQUATIONS, MATH SYMBOLS, SUBSCRIPTS, AND SUPERSCRIPTS
%
% IMPORTANT
% Below are a few tips to help format your equations and other special characters according to our specifications. For more tips to help reduce the possibility of formatting errors during conversion, please see our LaTeX guidelines at http://journals.plos.org/plosone/s/latex
%
% For inline equations, please be sure to include all portions of an equation in the math environment.  For example, x$^2$ is incorrect; this should be formatted as $x^2$ (or $\mathrm{x}^2$ if the romanized font is desired).
%
% Do not include text that is not math in the math environment. For example, CO2 should be written as CO\textsubscript{2} instead of CO$_2$.
%
% Please add line breaks to long display equations when possible in order to fit size of the column. 
%
% For inline equations, please do not include punctuation (commas, etc) within the math environment unless this is part of the equation.
%
% When adding superscript or subscripts outside of brackets/braces, please group using {}.  For example, change "[U(D,E,\gamma)]^2" to "{[U(D,E,\gamma)]}^2". 
%
% Do not use \cal for caligraphic font.  Instead, use \mathcal{}
%
% % % % % % % % % % % % % % % % % % % % % % % % 
%
% Please contact latex@plos.org with any questions.
%
% % % % % % % % % % % % % % % % % % % % % % % %

\documentclass[10pt,letterpaper]{article}
\usepackage[top=0.85in,left=2.75in,footskip=0.75in]{geometry}

% amsmath and amssymb packages, useful for mathematical formulas and symbols
\usepackage{amsmath,amssymb}


% Use adjustwidth environment to exceed column width (see example table in text)
\usepackage{changepage}

% textcomp package and marvosym package for additional characters
\usepackage{textcomp,marvosym}

% cite package, to clean up citations in the main text. Do not remove.
%\usepackage{cite}

% Use nameref to cite supporting information files (see Supporting Information section for more info)
\usepackage{nameref,hyperref}

% line numbers
\usepackage[right]{lineno}

% ligatures disabled
\usepackage[nopatch=eqnum]{microtype}
\DisableLigatures[f]{encoding = *, family = * }

% color can be used to apply background shading to table cells only
\usepackage[table]{xcolor}

% array package and thick rules for tables
\usepackage{array}

% create "+" rule type for thick vertical lines
\newcolumntype{+}{!{\vrule width 2pt}}

% create \thickcline for thick horizontal lines of variable length
\newlength\savedwidth
\newcommand\thickcline[1]{%
  \noalign{\global\savedwidth\arrayrulewidth\global\arrayrulewidth 2pt}%
  \cline{#1}%
  \noalign{\vskip\arrayrulewidth}%
  \noalign{\global\arrayrulewidth\savedwidth}%
}

% \thickhline command for thick horizontal lines that span the table
\newcommand\thickhline{\noalign{\global\savedwidth\arrayrulewidth\global\arrayrulewidth 2pt}%
\hline
\noalign{\global\arrayrulewidth\savedwidth}}


% Remove comment for double spacing
%\usepackage{setspace} 
%\doublespacing

% Text layout

%\raggedright
\setlength{\parindent}{0.5cm}
\textwidth 5.25in 
\textheight 8.75in

% Bold the 'Figure #' in the caption and separate it from the title/caption with a period
% Captions will be left justified
\usepackage[aboveskip=1pt,labelfont=bf,labelsep=period,justification=raggedright,singlelinecheck=off]{caption}
\renewcommand{\figurename}{Fig}

% Use the PLoS provided BiBTeX style
%\bibliographystyle{plos2015}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother



% Header and Footer with logo
\usepackage{lastpage,fancyhdr,graphicx}
\usepackage{epstopdf}
%\pagestyle{myheadings}
\pagestyle{fancy}
\fancyhf{}
%\setlength{\headheight}{27.023pt}
%\lhead{\includegraphics[width=2.0in]{PLOS-submission.eps}}
\rfoot{\thepage/\pageref{LastPage}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrule}{\hrule height 2pt \vspace{2mm}}
\fancyheadoffset[L]{2.25in}
\fancyfootoffset[L]{2.25in}
\lfoot{\today}

%% Include all macros below

\newcommand{\lorem}{{\bf LOREM}}
\newcommand{\ipsum}{{\bf IPSUM}}

%% END MACROS SECTION


\usepackage[numbers]{natbib}
\bibliographystyle{plos2015.bst}
\begin{document}
\vspace*{0.2in}

% Title must be 250 characters or less.
\begin{flushleft}
{\Large
\textbf\newline{An Exploratory Evaluation into the Effect of Data Availability and Indictator Coverage on Parameter Estimates using Hamiltonian Monte Carlo} % Please use "sentence case" for title and headings (capitalize only the first word in a title (or heading), the first word in a subtitle (or subheading), and any proper nouns).
}
\newline
% Insert author names, affiliations and corresponding author email (do not include titles, positions, or degrees).
\\
Jim Duggan\textsuperscript{1}
\\
\bigskip
\textbf{1} School of Computer Science, University of Galway, Galway, Ireland.
% \\
% \textbf{2} Affiliation Dept/Program/Center, Institution Name, City, State, Country
% \\
% \textbf{3} Affiliation Dept/Program/Center, Institution Name, City, State, Country
% \\
% \bigskip

% Insert additional author notes using the symbols described below. Insert symbol callouts after author names as necessary.
% 
% Remove or comment out the author notes below if they aren't used.
%
% Primary Equal Contribution Note
% \Yinyang These authors contributed equally to this work.

% Additional Equal Contribution Note
% Also use this double-dagger symbol for special authorship notes, such as senior authorship.
% \ddag These authors also contributed equally to this work.
% 
% % Current address notes
% \textcurrency Current Address: Dept/Program/Center, Institution Name, City, State, Country % change symbol to "\textcurrency a" if more than one current address note
% % \textcurrency b Insert second current address 
% % \textcurrency c Insert third current address
% 
% % Deceased author note
% \dag Deceased
% 
% % Group/Consortium Author Note
% \textpilcrow Membership list can be found in the Acknowledgments section.

% Use the asterisk to denote corresponding authorship and provide email address in note below.
% * correspondingauthor@institute.edu

\end{flushleft}
% Please keep the abstract below 300 words
\section*{Abstract}
There are typically two important questions addressed via the model calibration process: (1) does the time series of the fitted model match to the historical data; and (2) can reliable parameter estimates be inferred that are bounded within credible intervals. The evolution of Markov Chain Monte Carlo (MCMC) methods provide powerful methodological and computational frameworks for parameter estimation, and recent studies confirm the value of the Hamiltonian Monte Carlo approach for system dynamics models. This paper addresses an important research question for the calibration process, namely: what is the impact of data availability and indicator coverage on parameter estimation. It presents a 3 x 7 factorial study based on an SEIR model with hospitalisations and deaths. An extensive exploratory analysis is presented, and the highlights differences for a number of posterior distributions calculated, depending on the data availablity, and the set of indicators.


% Please keep the Author Summary between 150 and 200 words
% Use first person. PLOS ONE authors please skip this step. 
% Author Summary not valid for PLOS ONE submissions.   

\linenumbers

% Use "Eq" instead of "Equation" for equation citations.
\newpage

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

Contributions

Three indicator model SEIR simple model

Overall pipeline for efficiently processing inference results

Use of a new method (overlapping analysis) to measure differences in parameter estimates

\hypertarget{model-structure-and-experimental-design}{%
\section{Model Structure and Experimental Design}\label{model-structure-and-experimental-design}}

The model used is an extension the well-known deterministic SEIR structure \citep{vynnycky2010introduction}, and is shown in Figure \ref{fig:mod-seir}. People start out as being susceptible to a novel pathogen, and with the introduction of \emph{patient zero} to the infectious (I) stock, the contagion loop is activated. People then move to an exposed (E) stock, where they do not contribute to the force of infection (\(\lambda\)), before entering an infectious state. Once in an infectious state people contribute to the force of infection (\(\lambda\)), before exiting via a first order exponential delay structure. A certain proportion of those infected have symptoms (clinical fraction), and a proportion of infectious are hospitalised, while the remainder recover. Hospitalisation is modelled as a third order delay structure, and 90\% of those hospitalised recover, while 10\% do not and move to the deaths stock (D). Three stocks (TC, TH, and TD) are used to record the cumulative numbers of cases, hospitalisations, and deaths.

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/SEIR} \caption{An SEIR Influenza Model with Hospitalisations and Deaths}\label{fig:mod-seir}
\end{figure}

Equations (1-4) for the main SEIR structure are shown below. The parameters \(\sigma\) and \(\gamma\) represent the inverse of the latent and infectious delays, \(c\) is the clinical fraction, and \(h\) is the hospitalisation fraction. The model assumes that only those who show symptoms can end up in the hospital stream. The force of infection \(\lambda\) is calculated based on product of the effective contact rate (\(\beta\)) with the number of infectious (\(I\)), divided by the total population (\(N\)).

\begin{align*}
\dot{S}      & = - \lambda S & (1) \\
\dot{E}      & =  \lambda S - \sigma E & (2) \\
\dot{I}      & =   \sigma E - (1-ch)\gamma I - ch\gamma I& (3) \\
\dot{R}      & =   (1-ch)\gamma I& (4) \\
\lambda      & = \beta\frac{I}{N} & (5) \\
\beta        & = 1.0 & (6) \\
\end{align*}

The hospitalisation stream is modelled via equations 7-13. It involves a straightforward sequence of stocks that model people staying in hospital, with the average length of stay (\(L\)) set to 10 days. The hospitalisation rate is governed by the fraction \(ch\) exiting the infectious stock, and therefore for this model, that will evaluate to \(0.6 \times 0.1=0.06\). Upon exiting hospital, \((1-d\)) move to the stock \(R_{H}\), while the fraction \(d\) move to the stock \(D\).

\begin{align*}
\dot{H_{1}}  & =   ch\gamma I - \frac{H_{1}}{L_{1}}& (7) \\
\dot{H_{2}}  & =   \frac{H_{1}}{L_{1}} - \frac{H_{2}}{L_{2}} & (8) \\
\dot{H_{3}}  & =   \frac{H_{2}}{L_{2}} - d\frac{H_{3}}{L_{3}} - (1-d)\frac{H_{3}}{L_{3}}& (9) \\
\dot{R_{H}}  & =   (1-d)\frac{H_{3}}{L_{3}}& (10) \\
\dot{D}      & =   d\frac{H_{3}}{L_{3}}   & (11) \\
L_{1} = L_{2} = L_{3}     & = \frac{L}{3.0} & (12) \\
L            & = 10 & (13) \\
\end{align*}

As part of the inference process, we need to generate rates for cases (14), hospitalisations (15), and deaths (16), and these numbers are recorded as cumulative (stock) values. The Stan file generated (via the package \texttt{readsdr}) will difference these values in order to compare the simulated model values with the (synthetic) data values as part of the likelihood calculations for the posterior distributions.

\begin{align*}
\dot{T_{C}}  & =  c\sigma E & (14) \\
\dot{T_{H}}  & =  ch\gamma I & (15) \\
\dot{T_{D}}  & =  d\frac{H_{3}}{L_{3}} &(16) \\
\end{align*}

Finally, we present the relevant model parameters for the experiments. Two of these are based on the literature relating to pandemic influenza \citep{vynnycky2008analyses}, and the remaining values are arbitrary choices used as part of the experimentation process. For example, four of these parameters (\(\beta\), \(c\), \(d\) and \(h\)) will be estimated as part of the inference process.

\begin{center}  
\begin{tabular}{ | l | c | c | l | l |} % you can change the dimension according to the spacing requirements  
\hline  
Name & Symbol & Value  & Units & Source \\ \hline  
Latent Duration & $\sigma^{-1}$ & 2.0 & $Days$ & Vynnycky et al. [3]\\ \hline  
Infectious Duration & $\gamma^{-1}$ & 2.0 & $Days$ & Vynnycky et al. [3]\\ \hline  
Effective Contact Rate & $\beta$ & 1.0 & $Days^{-1}$ & Model estimate\\ \hline  
Clinical Fraction (CF)& $c$ & 0.60 & $Dimn$ & Model estimate\\ \hline  
Death Fraction (DF) & $d$ & 0.10 & $Dimn$ & Model estimate\\ \hline 
Hospitalisation Fraction (HF) & $h$ & 0.10 & $Diml$ & Model estimate\\ \hline 
Average Length of Stay & $L$ & 10.0 & $Days$ & Model estimate\\ \hline 
\end{tabular}  
\end{center}

\hypertarget{computational-framework}{%
\section{Computational Framework}\label{computational-framework}}

Figure \ref{fig:sys-design} captures the overall computational framework used to configure the experiments, generate the results, and produce the analysis. In order to execute this workflow, which is open-source and designed using R \citep{duggan2016system}, a number of additional components were required:

\begin{itemize}
\item
  Stan \citep{carpenter2017stan}, a statistical modelling platform, which provides an interface to perform Bayesian inference via the No-U-Turn-Sampler (NUTS). Stan models can contain ordinary differential equations, and is used to perform inference for deterministic models of infectious disease \citep{https://doi.org/10.1002/sdr.1693, ANDRADE2020100415, doi:10.1098/rsos.230515}
\item
  \texttt{cmdstanr} \citep{gabry2021cmdstanr}, which is a lightweight interface to Stan for R users.
\item
  \texttt{readsdr} \citep{andrade_readsdr}, a package that automatically converts XMILE ﬁles from Stella and Vensim to Stan code.
\item
  R's tidyverse packages, specifically \texttt{dplyr} for data manipulation, \texttt{ggplot2} for visualisation and \texttt{tidyr} for nesting data frames, a feature that allows the results to be conveniently organised into a 21 by 12 table.
\end{itemize}

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/sys_design} \caption{Overall data analytics framework for experiments}\label{fig:sys-design}
\end{figure}

The overall framework is divided into three main functions.

\begin{itemize}
\item
  \textbf{Generate Synthetic Data}, which runs the SEIR model using the package \texttt{readsdr} for one instance, and is based on the differencing of the three indicator stocks (see equations 13-15). The negative binomial distribution is used to generate random count variables based on the model outputs. For this experiment, the dispersion parameters selected are (10, 20, 40) for (Cases, Hospitalisations, and Deaths). Sample output from this process is shown in Figure \ref{fig:sys-syn}.
\item
  \textbf{Estimate Parameters}, which performs the fitting process. For each experiment, this will (1) use \texttt{readsdr} to generate a stan file, (2) run the stan file using the \texttt{cmdstanr} interface, and (3) prepare and store all of the results in a single multidimensional data structure. This structure will contain one row for each experiment, and encapsulate variables such as the number of indictors, the measurement model, the data used for the calibration, the posterior samples for each parameter (4,000 each), the time series output for each model run, and the duration of the run. Given the computational resources needed to run the fitting, an advantage of storing all the results in a database (RDS file used) is that the analysis stage can be conducted at a later stage.
\item
  \textbf{Analyse Results}, which provides a number of scripts to generate a range of results to support analysis. These include: trace plots to explore convergence; time series showing the fits; boxplots highlighting the parameter distributions across all 21 experiments; quantile analysis to show the 95\% credible intervals from the inference process; and overlap analysis to provide insights into how close the posterior distributions are for each combination of epoch and indicator.
\end{itemize}

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/sys_synthetic} \caption{Sample synthetic data generated for the experiments}\label{fig:sys-syn}
\end{figure}

The results are now presented in more detail.

\hypertarget{experimental-results}{%
\section{Experimental Results}\label{experimental-results}}

Overall, the inference process for the 21 experiments generates over 273MB of data, so there is a wide range of analysis that can be performed. Given that the overall goal is to explore possible differences in parameter estimates, our analysis comprises the following stages:

\begin{itemize}
\item
  Presentation of convergence tests for each parameter over the four MCMC chains, for each of the 21 data configurations.
\item
  Exploring of the model fits, to confirm that the parameter estimates generate plausible dynamic behaviour for each model.
\item
  Boxplots to highlight the distribution of inferred parameters, and to see how the estimates line up with the original values used to construct the synthetic data sets.
\item
  Overlapping analysis, defined as the area intersected by two or more probability density functions \citep{Pastore2018, 10.3389/fpsyg.2019.01089}, to provide a measure of how close the estimates are across each of the 21 experiments.
\end{itemize}

\hypertarget{convergence-tests}{%
\subsection{Convergence Tests}\label{convergence-tests}}

Our first analysis, capture in Figure \ref{fig:exp-conv}, displays the trace plots showing how the estimates of the parameter values change over the MCMC process. Four MCMC chains are run, with 1000 iterations for the warm-up phase, and 1000 for the sampling process. The goal is to ensure that a stationary distribution is achieved for all parameters \citep{https://doi.org/10.1002/sdr.1693}, and this is achieved, and confirmed by analysing the output from stan, which showed no divergences within all the samples. This chain convergence is an important property of the inference method. However, the plots can also illustrate interesting properties of the fitted parameters. Through observation, we can see the different ranges of the estimates, for example:

\begin{itemize}
\item
  Experiments involving epoch one (the opening phase of the epidemic) typically have wider ranges, which is as expected, as there is less data available to inform the fitting process. For example, for the parameter \texttt{HF} (true value \(0.1\)), the values for \texttt{Epoch1-C} seem to cover the interval from 0 to 1.
\item
  Experiments where the three indicators were used tend to have narrower bands, which again is not surprising given that more information is available for the calibration process. Returning to parameter \texttt{HF}, we can see that its values for \texttt{Epoch1-CHD} remain much closer to the true value of \(0.1\).
\end{itemize}

A more detailed analysis of these parameter values will be explored through boxplots, quantile analysis and overallping analysis.

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_convergence} \caption{Exploring parameter convergence}\label{fig:exp-conv}
\end{figure}

\hypertarget{model-fits}{%
\subsection{Model fits}\label{model-fits}}

An important requirement for calibration is that the model provides a plausible representation of historical data, and in MCMC fitting we can also explore the time series quantiles returned as part of the posterior distribution. From a process perspective, having fits that align with historical data is needed to confirm that the model structure can generate the behaviour of interest, and these outputs also can be deployed as a confidence-building measure for modellers and clients. A sample of the fits are displayed in Figure \ref{fig:exp-fits}, for the indicators \emph{Cases} and \emph{Deaths}, across three of the epochs. The mean value from the MCMC samples is also shown, and overall, on visual inspection, these look like good fits to the data.

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_fits} \caption{A sample of fits from the inference process (95\% CI)}\label{fig:exp-fits}
\end{figure}

An interesting aspect is what the fits do not show, which is the range of parameter values underling the generated time series. For example, if you take the set of plots in row 1 column 1 (epoch 1), and compare the fits for indicator \emph{C} and indicators \emph{CHD}, there is not an observable distinction between both, in that both fits look plausible. However, when we compare the parameters estimated for these two samples, differences emerge. This can first be explored using boxplots.

\hypertarget{boxplots-of-parameter-estimates}{%
\subsection{Boxplots of parameter estimates}\label{boxplots-of-parameter-estimates}}

The boxplot is a valuable method to summarise data, as it shows the median, the interquartile range (IQR), the location of values 1.5 times above and below the 75th and 25th percentiles, and outliers. We use the boxplot as a means to compare parameter values from all 21 experiments, and estimated across (1) each of the three epochs and (2) all of the seven combinations of data indicators. The 84 boxplots are presented in Figure \ref{fig:exp-boxplots}.

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_boxplots} \caption{Box plot analysis for parameters by epoch and indicator source(s)}\label{fig:exp-boxplots}
\end{figure}

We can observe a number of patterns from these descriptive statistics:

Why might this be the case? NArrow to expansive\ldots{} tipping point?

\hypertarget{quantile-analyis-of-fitted-parameters}{%
\subsection{Quantile analyis of fitted parameters}\label{quantile-analyis-of-fitted-parameters}}

The plots displayed in the preceding section are useful to gain an overall appreciation of the posterior distributions, and to supplement that analysis, it is important to show the 95\% credible intervals. For the four parameters, this information is presented in Figure \ref{fig:exp-quants}, and arranged in descending order by the difference between the upper and lower quantiles.

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_quants} \caption{Summary of quantiles for parameters across the 21 experiments.}\label{fig:exp-quants}
\end{figure}

A number of points can be made when reflecting on these results, and focusing on the first three records for each parameter (sorted in ascending order based on the narrowness of the credible interval):

\hypertarget{overlap-analysis-of-parameter-densities}{%
\subsection{Overlap analysis of parameter densities}\label{overlap-analysis-of-parameter-densities}}

Disadvantage (scale)

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_density_b_cf} \caption{Visualizing a list of three elements}\label{fig:exp-density-1}
\end{figure}

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_density_hf_df} \caption{Visualizing a list of three elements}\label{fig:exp-density-2}
\end{figure}

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_overlap_beta} \caption{Visualizing a list of three elements}\label{fig:exp-overlap-beta}
\end{figure}

\begin{figure}
\includegraphics[width=1\linewidth]{diagrams/exp_overlap_HF} \caption{Overlapping calculations for hospitalisation fraction (HF)}\label{fig:exp-overlap-hf}
\end{figure}

\hypertarget{discussion}{%
\section{Discussion}\label{discussion}}


\bibliography{references.bib}

\end{document}
